name: ç¼–è¯‘ledeçš„æº

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  URL: https://github.com/coolsnowwolf/lede
  BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest  # ä¿®æ­£ä¸ºæœ‰æ•ˆè¿è¡Œå™¨ç±»å‹

    steps:
    - name: Checkout
      uses: actions/checkout@v4  # ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬

    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo "::group::ğŸ–¥ï¸ æœåŠ¡å™¨èµ„æºè¯¦æƒ…"
        lscpu | grep -E 'Model name|Socket|Thread'
        echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
        free -h
        df -Th
        echo "::endgroup::"

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* \
          /usr/share/dotnet \
          /usr/local/lib/android \
          /opt/ghc \
          /opt/hostedtoolcache/CodeQL
        sudo docker system prune -a -f
        sudo apt-get -qq update
        sudo apt-get -qq install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
          gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 \
          libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
          libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch \
          pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils \
          rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown -R $USER:$GROUPS /workdir

    - name: å…‹éš†æºä»£ç 
      run: |
        echo "::group::ğŸ“¦ å­˜å‚¨ç©ºé—´ä¿¡æ¯"
        df -hT $PWD
        echo "::endgroup::"
        git clone --depth 1 $URL -b $BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        if [ -f "../$DIY_P1_SH" ]; then
          echo "::group::ğŸš€ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ Part1"
          chmod +x ../$DIY_P1_SH
          cp ../$FEEDS_CONF openwrt/feeds.conf.default
          cd openwrt && ../$DIY_P1_SH
          echo "::endgroup::"
        fi

    - name: æ›´æ–° feeds
      run: |
        cd openwrt
        echo "::group::ğŸ”„ æ›´æ–°è½¯ä»¶æº"
        ./scripts/feeds update -a
        echo "::endgroup::"

    - name: å®‰è£… feeds
      run: |
        cd openwrt
        echo "::group::ğŸ“¥ å®‰è£…è½¯ä»¶åŒ…"
        ./scripts/feeds install -a
        echo "::endgroup::"

    - name: åº”ç”¨è‡ªå®šä¹‰é…ç½®
      run: |
        if [ -f "../$DIY_P2_SH" ]; then
          echo "::group::ğŸš€ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ Part2"
          chmod +x ../$DIY_P2_SH
          cd openwrt && ../$DIY_P2_SH
          echo "::endgroup::"
        fi
        cp ../$CONFIG_FILE .config
        make defconfig

    - name: ä¸‹è½½ä¾èµ–
      run: |
        cd openwrt
        echo "::group::ğŸ“¦ ä¸‹è½½è½¯ä»¶åŒ…"
        make download -j$(($(nproc) + 1)) || make download -j1 V=s
        echo "::endgroup::"
        echo "::group::ğŸ” æ£€æŸ¥æ— æ•ˆæ–‡ä»¶"
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        echo "::endgroup::"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt
        echo "::group::ğŸ—ï¸ ç¼–è¯‘æ—¥å¿— (è¯¦ç»†æ¨¡å¼)"
        make -j$(($(nproc) + 1)) || make -j1 V=s
        echo "::endgroup::"
      continue-on-error: true  # å…è®¸å¤±è´¥ä»¥æ•è·æ—¥å¿—

    - name: æ”¶é›†ç¼–è¯‘ç»“æœ
      if: ${{ always() }}
      run: |
        echo "::group::ğŸ“Š æœ€ç»ˆå­˜å‚¨ç©ºé—´ä½¿ç”¨"
        df -hT
        echo "::endgroup::"
        
        cd openwrt/bin/targets/*/*
        echo "::group::ğŸ“ ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨"
        find . -type f -printf "%T+ %p\n" | sort
        echo "::endgroup::"
        
        # é‡å‘½åå¸¦æ—¥æœŸæ—¶é—´æˆ³çš„æ–‡ä»¶
        for f in *; do
          mv "$f" "$(date +%Y%m%d)-${f}"
        done

    - name: ä¸Šä¼ ç¼–è¯‘ç»“æœ
      uses: actions/upload-artifact@v4
      if: ${{ always() }}
      with:
        name: firmware-${{ github.run_id }}
        path: openwrt/bin/targets/*/*/*
        retention-days: 3

    - name: å¤±è´¥é€šçŸ¥
      if: ${{ failure() }}
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: "âŒ ç¼–è¯‘å¤±è´¥ï¼è¯·æ£€æŸ¥ [å·¥ä½œæµè¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          })
