name: ç¼–è¯‘ledeçš„æº

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  URL: https://github.com/coolsnowwolf/lede
  BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: lede.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on:  ubuntu-22.04 

    steps:
    - name: Checkout
      uses: actions/checkout@v4  # ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬

    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo "::group::ğŸ–¥ï¸ æœåŠ¡å™¨èµ„æºè¯¦æƒ…"
        echo "âš ï¸ é‡è¦æç¤º"
        echo "è‹¥æœåŠ¡å™¨æ€§èƒ½ä¸è¶³è¯·ç«‹å³å–æ¶ˆè¿è¡Œï¼å·²çŸ¥å…¼å®¹å‹å·ï¼šRyzen 8370C/8171M"
        echo "::group::ğŸ–¥ï¸ æœåŠ¡å™¨èµ„æºè¯¦æƒ…"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
        echo "CPUå‹å·: $(lscpu | grep 'Model name' | cut -d: -f2 | xargs)"
        echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        echo "å†…å­˜æ€»é‡: $(free -h | awk '/Mem/{print $2}')"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        df -Th
        echo "::endgroup::"
        echo "::endgroup::"

    - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* \
          /usr/share/dotnet \
          /usr/local/lib/android \
          /opt/ghc \
          /opt/hostedtoolcache/CodeQL
        sudo docker system prune -a -f
        sudo apt-get -qq update
        sudo apt-get -qq install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
          gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 \
          libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
          libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch \
          pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils \
          rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown -R $USER:$GROUPS /workdir

    - name: å…‹éš†æºä»£ç 
      run: |
        echo "::group::ğŸ“¦ å­˜å‚¨ç©ºé—´ä¿¡æ¯"
        df -hT $PWD
        echo "::endgroup::"
        git clone --depth 1 $URL -b $BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®diy-part1.sh
      run: |
        echo "::group::ğŸš€ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬diy-part1.sh"
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH
        echo "::endgroup::"

    - name: æ›´æ–° feeds
      run: |
        cd openwrt
        echo "::group::ğŸ”„ æ›´æ–°è½¯ä»¶æº"
        ./scripts/feeds update -a
        echo "::endgroup::"

    - name: å®‰è£… feeds
      run: |
        cd openwrt
        echo "::group::ğŸ“¥ å®‰è£…è½¯ä»¶åŒ…"
        ./scripts/feeds install -a
        echo "::endgroup::"

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®diy-part2.sh
      run: |
        echo "::group::ğŸš€ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬diy-part2.sh"
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH
        echo "::endgroup::"

    - name: ä¸‹è½½ä¾èµ–
      run: |
        cd openwrt
        make defconfig
        echo "::group::ğŸ“¦ ä¸‹è½½è½¯ä»¶åŒ…"
        make download -j$(($(nproc) + 1)) || make download -j1 V=s
        echo "::endgroup::"
        echo "::group::ğŸ” æ£€æŸ¥æ— æ•ˆæ–‡ä»¶"
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        echo "::endgroup::"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt
        echo "::group::ğŸ—ï¸ ç¼–è¯‘æ—¥å¿— (è¯¦ç»†æ¨¡å¼)"
        make -j$(($(nproc) + 1)) || make -j1 V=s
        echo "::endgroup::"
      continue-on-error: true  # å…è®¸å¤±è´¥ä»¥æ•è·æ—¥å¿—

    - name: æ”¶é›†ç¼–è¯‘ç»“æœ
      if: ${{ always() }}
      run: |
        echo "::group::ğŸ“Š æœ€ç»ˆå­˜å‚¨ç©ºé—´ä½¿ç”¨"
        df -hT
        echo "::endgroup::"
        
        cd openwrt/bin/targets/*/*
        echo "::group::ğŸ“ ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨"
        find . -type f -printf "%T+ %p\n" | sort
        echo "::endgroup::"
        
        # é‡å‘½åå¸¦æ—¥æœŸæ—¶é—´æˆ³çš„æ–‡ä»¶
        for f in *; do
          mv "$f" "$(date +%Y%m%d)-${f}"
        done

    - name: ä¸Šä¼ ç¼–è¯‘ç»“æœ
      uses: actions/upload-artifact@v4
      if: ${{ always() }}
      with:
        name: firmware-${{ github.run_id }}
        path: openwrt/bin/targets/*/*/*
        retention-days: 3

    - name: å¤±è´¥é€šçŸ¥
      if: ${{ failure() }}
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: "âŒ ç¼–è¯‘å¤±è´¥ï¼è¯·æ£€æŸ¥ [å·¥ä½œæµè¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          })
